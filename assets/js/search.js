
var documents = [{
    "id": 0,
    "url": "https://www.wroscoe.com/404.html",
    "title": "",
    "body": " 404 Page not found :(  The requested page could not be found. "
    }, {
    "id": 1,
    "url": "https://www.wroscoe.com/about/",
    "title": "About",
    "body": "This is a place to explore how we can use technology to design a better way to live. "
    }, {
    "id": 2,
    "url": "https://www.wroscoe.com/categories/",
    "title": "Tags",
    "body": "Contents: {% if site. categories. size &gt; 0 %} {% for category in site. categories %} {% capture category_name %}{{ category | first }}{% endcapture %} {{ category_name }}{% endfor %}{% endif %} {% for category in site. categories %}  {% capture category_name %}{{ category | first }}{% endcapture %} &lt;h3 id = {{ category_name }} &gt;&lt;i class= fas fa-tags category-tags-icon &gt;&lt;/i&gt;&lt;/i&gt; {{ category_name }}&lt;/h3&gt;&lt;a name= {{ category_name | slugize }} &gt;&lt;/a&gt;{% for post in site. categories[category_name] %}{%- assign date_format = site. minima. date_format | default:  %b %-d, %Y  -%}&lt;article class= archive-item &gt; &lt;p class= post-meta post-meta-title &gt;&lt;a class= page-meta  href= {{ site. baseurl }}{{ post. url }} &gt;{{post. title}}&lt;/a&gt; • {{ post. date | date: date_format }}&lt;/p&gt;&lt;/article&gt;{% endfor %} {% endfor %}"
    }, {
    "id": 3,
    "url": "https://www.wroscoe.com/contagion_break_spread.html",
    "title": "How we could have broken the chain that caused the Contagion virus to spread.",
    "body": "2020/02/27 -           As the coronavirus spreads into a pandemic, I watched Contagion to lighten mood. Spoiler Alert! At the end of the movie the sequence showing the path the virus took from animal to human. It became obvious that at each step there was a way that it could have been prevented. Build a pig pen that keeps bats out. The pig could have been butchered before it was in the kitchen next to guests. The could could have washed his hands. The cook could have avoided holding hands with somewone else. The guest (patient 1) could have washed her hands after shaking hands with the cook. Any one of these would have stopped the spread and broken the chain. After this 5 other people were infected so there are 5 other chains that need to be broken. Once a virus becomes a pandemic we must think about how to systematically break the chain. This can be done as people build of their immunities either after the recover from the virus or with a vaccine. However everyone can contribute to breaking the links of the spread by limiting their exposure and improving their hygiene.  Here is a video from John Campbell  "
    }, {
    "id": 4,
    "url": "https://www.wroscoe.com/2019/Economy_prediction_v0.html",
    "title": "My prediction for the world economy (Oct 2019).",
    "body": "2019/10/16 - As an effort to hold my responsible for thinking rationally I’m publishing my prediction for the overall trend of the global economy. I know very little about economics so please don’t use this as investment advice. In the next 12 months we’ll enter a global recession caused by the boomers retiring. As the boomers retire they will begin liquidating their savings currently held in stocks and bonds. The stock market will fall and bond interest rates will rise. The higher interest rates will cause many leveraged companies to go bankrupt, further depressing the economy. The shrinking economy will reduce tax revenues for the US government and necessitate the treasury to sell $2-4 trillion worth of US bonds at a time when interest rates are already high. In an effort to keep interest rates low and to restart the economy, the US federal reserve will buy treasury bonds and other assets by printing money (ie quantitative easing). Major holders of US Treasury bonds which are foreign governments and pension funds will see that the US government can only inflate it’s way out of their debt liabilities so they will sell their bonds and US dollar reserves. This rush out of of US dollars will collapse it’s value relative to gold, bitcoin and hard assets. "
    }, {
    "id": 5,
    "url": "https://www.wroscoe.com/2017/port_compound_eye.html",
    "title": "Line detection autopilot using Python + OpenCV.",
    "body": "2017/02/02 -           In a previous post I walked through how to create a lane keeping autopilot using an end-to-end neural network. This post shows how to create a lane keeping autopilot using line detection computer vision algorithms. This is essentially a python port of the C++ computer vision autopilot, written by Haoyang Wang, and Jason Devitt from Compound Eye. It was the only vehicle to complete the first DIYRobocar Race.  Load Images :       import osimport cv2import numpy as npimport randomimport mathimport matplotlibfrom matplotlib. pyplot import imshowfrom matplotlib import pyplot as plt%matplotlib inline          dir_path = &#39;/home/wroscoe/donkey_data/sessions/wr_1240/&#39;images = os. listdir(dir_path)img_paths = [os. path. join(dir_path, i) for i in images]img_paths. sort()#Read images, flip them vertically, and convert them to RGB color orderimg_all = np. array([cv2. cvtColor(cv2. imread(p), cv2. COLOR_BGR2RGB) for p in img_paths])#find image dimensionsimshow(img_all[0])  &lt;matplotlib. image. AxesImage at 0x7fe445d4c978&gt;  A third of this pictures shows the warehouse rather than the track. Lets cut off this part of the image.       img_all = np. array([img[40:, :] for img in img_all])img_height = img_all[0]. shape[0]img_width = img_all[0]. shape[1]imshow(img_all[0])  &lt;matplotlib. image. AxesImage at 0x7fe445d34470&gt;        #only use a couple example imagesimg_arr = img_all[95:100]          #helper function to show several imagesdef show_imgs(img_arr, cmap=None):    fig, ax = plt. subplots(1, img_arr. shape[0], figsize=(15, 6),               subplot_kw={&#39;adjustable&#39;: &#39;box-forced&#39;})  axoff = np. vectorize(lambda ax:ax. axis(&#39;off&#39;))  axoff(ax)  for i, img in enumerate(img_arr):    ax[i]. imshow(img, cmap=cmap)          #show original imagesshow_imgs(img_arr)    Find Lines : Now that we have our pictures loaded, lets find the lines of the course.       #remove colors and show greyscalegray_arr = np. array([cv2. cvtColor(img, cv2. COLOR_BGR2GRAY) for img in img_arr])show_imgs(gray_arr, cmap=&#39;gray&#39;)          #blur images to avoid recognizing small linesblur_arr = np. array([cv2. blur(arr,(5,5)) for arr in gray_arr])#blur_arr = gray_arrshow_imgs(blur_arr, cmap=&#39;gray&#39;)          #use canny threshold to find edges of shapescanny_threshold1 = 100canny_threshold2 = 130canny_arr = np. array([cv2. Canny(arr, canny_threshold1, canny_threshold2) for arr in blur_arr])show_imgs(canny_arr, cmap=&#39;gray&#39;)          hough_threshold = 2min_line_length = 3max_gap = 5rho = 2. theta = . 3line_arr = []line_coord_arr = []line_count = 0for i, canny in enumerate(canny_arr):  lines = cv2. HoughLinesP(canny, rho, theta, hough_threshold,               min_line_length, max_gap)  img = img_arr[i]  if lines is not None:    for line in lines:       #format line to be drawn      x1, y1, x2, y2 = line[0]      line_coord = np. array([[[x1, y1], [x2, y2]]], dtype=float)      #draw line      cv2. line(img,(x1,y1),(x2,y2),(0,255,0),3)            line_count += 1        line_arr. append(img)  line_arr = np. array(line_arr)show_imgs(line_arr)    Get a birds eye view of the lines : To calculate the steering angle we'll use a perspective transform to simulate a birds eye view from the tip. This way we can calculate the actual angle of the line relative to the car. The first step is to calculate the required transform from the camera angle to a top view. OpenCV provides an easy function to do this if you can provide a rectangle before and after the transform. Find the corners of a rectangle on the road. Define where those corners would be from a birds eye view. Use OpenCV to find this transformation matrix. Use this transformation matrix to change the perspective of your images. I did this by first taking picture of a standard 8. 5 x11  letter size paper from my car and finding the corner cordinates.       #Load calibration imageimg_path = &#39;/home/wroscoe/donkey_data/sessions/cv_orient/frame_00001_ttl_0_agl_0_mil_0. jpg&#39;img = cv2. cvtColor(cv2. imread(img_path), cv2. COLOR_BGR2RGB)[40:, :]#coordinates of corners: order is [top left, top right, bottom right, bottom left]corners = np. array([(57,39), (110,39), (122,75), (39, 75)], dtype=&quot;float32&quot;)#draw points on new imageimg2 = img. copy()for c in corners:  cv2. circle(img2, tuple(c), 3, (0,255,0), -1)  imshow(img2)    &lt;matplotlib. image. AxesImage at 0x7fe43efb9eb8&gt;  Now we define where that rectangle should be if we're looking from the top veiew perspective and calculate the transformation matrix.       def four_point_transform(pts):  maxWidth, maxHeight = 300, 300  hwratio = 11/8. 5 #letter size paper  scale = int(maxWidth/12)    center_x = 150  center_y = 250    dst = np. array([  [center_x - scale, center_y - scale*hwratio], #top left  [center_x + scale, center_y - scale*hwratio], #top right  [center_x + scale, center_y + scale*hwratio], #bottom right  [center_x - scale, center_y + scale*hwratio], #bottom left  ], dtype = &quot;float32&quot;)  # compute the perspective transform matrix and then apply it  M = cv2. getPerspectiveTransform(pts, dst)    return MM = four_point_transform(corners)M  array([[ 2. 43902439e+00,  6. 30081301e+00, -6. 15853659e+01],    [ -4. 30211422e-15,  1. 61246610e+01, -6. 61644977e+01],    [ -1. 45283091e-17,  4. 06504065e-02,  1. 00000000e+00]])  When we apply that transformation to the same image we can see that the paper now looks like it would from the top.       warped = cv2. warpPerspective(img2, M, (300, 300))imshow(warped)  &lt;matplotlib. image. AxesImage at 0x7fe43f05aa58&gt;  Here is the same transformation applied to pictures from the track.       warped_arr = np. array([cv2. warpPerspective(i, M, (300, 300)) for i in img_arr])show_imgs(warped_arr)      Calculate steering angles : Compute the angle that the line segments make with the horizontal. Filter out line segments that appear on one side of the image only and lean outwards, on the assumption that we’re not in danger of crossing those. Cluster the rest by angle. Find the cluster with the longest combined length, and set that angle as our steering angle. Find lines : Here we are createing a single function to extract the lines from the image and transform them to a birds eye perspective.       def get_lines(img, blur_pixels=5, canny_threshold1=100, canny_threshold2=130,       rho=2, theta=. 02, min_line_length=80, max_gap=20, hough_threshold=9):    #print(rho, theta, min_line_length, max_gap, hough_threshold)    img_gray = cv2. cvtColor(img, cv2. COLOR_BGR2GRAY)  img_blur = cv2. blur(img_gray,(blur_pixels,blur_pixels))  img_canny = cv2. Canny(img_blur, canny_threshold1, canny_threshold2)  lines = cv2. HoughLinesP(img_canny, rho, theta, hough_threshold, min_line_length, max_gap)    if lines is not None:    lines = lines. reshape((lines. shape[0],2,2))    lines = lines. astype(float)    lines = cv2. perspectiveTransform(lines, M)  return lines    Now we need methods to calculate the length and angle of the lines we've found.       def line_length(arr):  l = math. sqrt( (arr[0,0] - arr[1,0])**2 + (arr[0,1] - arr[1,1])**2 )  return ldef line_angle(arr):  dx = arr[1,0] - arr[0,0]  dy = arr[1,1] - arr[0,1]  rads = math. atan2(-dy,dx)  rads %= 2*math. pi  degs = -math. degrees(rads)  if degs &lt;= -180:     degs = degs + 180      degs = degs + 90  return degs    A conviencience function to calculate length and angle an array of lines. Return results sorted by angles so we can cluster them in then next step.       def compute_lines(lines):  from operator import itemgetter    line_data = []  for line in lines:    line_data. append([line_angle(line), line_length(line)])  sorted(line_data, key=itemgetter(0))  return line_data    Cluster the angle/legths if the angles are less than 20 degrees different than the last angle.       def cluster_angles(line_data):  clusters = []  last_angle = -180  for a, l in line_data:    if abs(last_angle - a) &gt; 20:      clusters. append([(a,l)])    else:      clusters[-1]. append((a,l))  return clusters    Find the cluster that has the longest aggregate line length and average the angles of the lines in the cluster.       def decide_angle(clustered_angles):  max_length = 0  max_cluster_id = -1  for i, c in enumerate(clustered_angles):    #sum lenght of lines found in clusters, filter out angles &gt; 80 (likely in horizon)    cluster_length = sum([l for a, l in c if abs(a) &lt; 80])    #print(&#39;cluster length&#39;, cluster_length)    if cluster_length &gt; max_length:      max_length = cluster_length      max_cluster_id = i  if max_cluster_id&gt;-1:    angles = [a for a, l in clustered_angles[max_cluster_id]]    #return average angle of cluster    return sum(angles)/len(angles)   #print(angles)  else:    return 0    Bring it all together : This performs the steering calculations for every image.       line_count = []decided_angles = []for i in img_all:  #print(&quot;Image&quot;)  lines = get_lines(i, hough_threshold = hough_threshold, min_line_length = min_line_length,            max_gap = max_gap, rho = rho, theta = theta)    #print(lines)  if lines is not None:    line_count. append(lines. shape[0])    line_data = compute_lines(lines)    clustered = cluster_angles(line_data)    #print(&#39;clustered: &#39;, clustered)    angle = decide_angle(clustered)    decided_angles. append(angle)    #print(&#39;angle: &#39;, angle)  else:    decided_angles. append(0)    Analyze Results : Now lets see how this looks compared to actual driving data. Here is the actual steering angle compared with the steering angel given by the this line detection algorthim. Its noisy but directionally accurate.       def parse_img_filepath(filepath):    f = filepath. split(&#39;/&#39;)[-1]    f = f. split(&#39;. &#39;)[0]    f = f. split(&#39;_&#39;)    throttle = int(f[3])    angle = int(f[5])    milliseconds = int(f[7])        data = {&#39;throttle&#39;:throttle, &#39;angle&#39;:angle, &#39;milliseconds&#39;: milliseconds}     return data          import pandas as pd          data = [parse_img_filepath(i) for i in img_paths]angles = [d[&#39;angle&#39;] for d in data]df = pd. DataFrame({&#39;cv&#39;:decided_angles, &#39;actual&#39;: angles})df[:300]. plot()  &lt;matplotlib. axes. _subplots. AxesSubplot at 0x7fe4342e77b8&gt;  Note: The actual steering angles used in this graph are skewed to be larger than they actually are. The max actual steering angle is closer to 45 deg. Next Steps : This may work well for differential steering vehicles but not for mechanical steering. Adding smoothing over time would help make this more stable. Write a training function that accepts training data and minimizes error between actual and predicted by tuning the line detection parameters. Build your own DIYRobocar. : For \$100-\$200 you can build your own self driving car. The Donkey repository is a good place to start for building structions and will save you time with the cruft / data plumbing. "
    }, {
    "id": 6,
    "url": "https://www.wroscoe.com/2017/jan_diyrobocar_race_debrief.html",
    "title": "January 2017 DIYRobocar Race Debrief",
    "body": "2017/01/22 -            Lessons learned from the last DIYRobocar race. Overall today was a success given that two Donkey controlled vehicles did at least one completely autonomous lap prior to race time. This is a big improvement from the same event 3 months ago when we worked on Adams car all day to get it to lurch forward and turn right. This is short debrief of what I learned this weekend to help guide our next efforts to make Donkey a better library for training autopilots for these races.  Of course, after the race the driving problems became obvious.  The vehicle drive loop was only updating every 1/5th of a second but should have been updating every 1/15th of a second or more frequently. This meant we didn’t collect very much training data and the autopilot didn’t update often. Training data was not cleaned. We didn’t have a good way to view the training data on the ec2 instance so we could not see that there we were using training data that included bad steering, and even images when the vehicle had been picked up. Beyond bugs, how can do better at these races? : On a race day, we have 4-6 hours to take a proven car and autopilot and train it to perform on a new track. The more efficiently we can improve the autopilot performance the better we’ll do. Here’s an overview problems I saw today and proposals how to fix them.  Specific issues and solutions live in github issues. Many steps are required to update an driving model. : At one point today I had 20+ terminal windows open because changing the autopilot requires many useless “plumbing” steps. These steps can be automated or made easier with command line arguments or web interface. Switching models requires restarting the serverIt's difficult to remember which session was the good session. Combining sessions is a separate script. Driving is required to test models. : Since updating and driving an autopilot takes time, we need to make sure that our changes actually improve the autopilot before we test it on the track. A trusted performance measurement is needed at the time of training. This could be a combination of the error on a validation dataset and a visual showing how closely predicted values were to actual. There is no way to debug an autopilot. : Currently an autopilot either works or it doesn’t. Driving performance are the only clues to help us understand what’s going wrong. Helpful clues would include:Adding a visual showing what the network is queuing off of would help. Lag timesPredicted vs actual overlaid on image. Common problems that don&#8217;t have obvious solutions. : Even after a common problem has been identified, there’s no standard solution to fix the problem. “Agile training” could be used to correct the autopilot by creating more training data where the autopilot fails. Vehicle doesn’t turn sharp enough. Vehicle doesn’t turn at all on a corner. Vehicle goes to slow. There is no easy way to clean training data on a remote instance. : Training on bad data makes bad autopilots. To learn where bad training data exists you need to see the image the recorded steering values, This is impossible on a CLI but would be possible through a web interface. There are other improvements we can make but these are the big unsexy ones that will help most. Also, get a friend to build a car. Build a Donkey or any of the other reference builds on DIYRobocars. Let the fleet learning begin.  Using donkey to control my car from a website using a javascript joystick. "
    }, {
    "id": 7,
    "url": "https://www.wroscoe.com/2017/lane_following_autopilot.html",
    "title": "Lane Following Autopilot with Keras & Tensorflow.",
    "body": "2017/01/12 -           This document walks through how to create a convolution neural network using Keras+Tensorflow and train it to keep a car between two white lines.  Updated Feb 2, 2017 - Thanks to comments on Hacker News, I've updated this doc to use more machine learning best pratices. Here is a Raspberry Pi controlled RC car using the autopilot crated in this document to drive between the lines. See the donkey repository for instructions to build your own car.        import osimport urllib. requestimport pickle%matplotlib inlineimport matplotlibfrom matplotlib. pyplot import imshow    Get the driving data : The dataset is composed of ~7900 images and steering angles collected as I manually drove the car. About 2/3 of the images are with the car between the lines. The other third is of the car starting off course and correcting by driving back to between the lines.       #downlaod driving data (450Mb) data_url = &#39;https://s3. amazonaws. com/donkey_resources/indoor_lanes. pkl&#39;file_path, headers = urllib. request. urlretrieve(data_url)print(file_path)  /tmp/tmpjjuhirpf  The dataset consists of 2 pickled arrays. X are the image arrays and Y is an array of the coresponding steering angles.       #extract datawith open(file_path, &#39;rb&#39;) as f:  X, Y = pickle. load(f)  print(&#39;X. shape: &#39;, X. shape)print(&#39;Y. shape: &#39;, Y. shape)imshow(X[0])  X. shape: (7892, 120, 160, 3)Y. shape: (7892,)&lt;matplotlib. image. AxesImage at 0x7f3f6b577828&gt;  Split Data : Here we'll shuffle our data and separate the data into three parts. Training data will be used to train our driving model, Validation data is used avoid overfitting the model and Test data is used to test if our model learned anything.       import numpy as np          #shuffle both X and Y the same waydef unison_shuffled_copies(X, Y):  assert len(X) == len(Y)  p = np. random. permutation(len(X))  return X[p], Y[p]shuffled_X, shuffled_Y = unison_shuffled_copies(X,Y)len(shuffled_X)  7892        test_cutoff = int(len(X) * . 8) # 80% of data used for trainingval_cutoff = test_cutoff + int(len(X) * . 1) # 10% of data used for validation and test data train_X, train_Y = shuffled_X[:test_cutoff], shuffled_Y[:test_cutoff]val_X, val_Y = shuffled_X[test_cutoff:val_cutoff], shuffled_Y[test_cutoff:val_cutoff]test_X, test_Y = shuffled_X[val_cutoff:], shuffled_Y[val_cutoff:]len(train_X) + len(val_X) + len(test_X)  7892  Augment Training Data : To double our training data and prevent steering bias, we flip each image and steering angle and add it to the dataset. There are additional ways to augment driving data using translations and fake shadows but I didn't use those for this autopilot.       X_flipped = np. array([np. fliplr(i) for i in train_X])Y_flipped = np. array([-i for i in train_Y])train_X = np. concatenate([train_X, X_flipped])train_Y = np. concatenate([train_Y, Y_flipped])len(train_X)  12626  Build a driving model : This driving model will be an end-to-end neural network that accepts image arrays as input and outputs a steering angle between -90 (left) and 90 (right). To do this we'll use a 3 layer convolution network with one fully connected layer. This model is based off of Otavio's Carputer but does not produce a throttle value output, does not use past steering values as input into the model, and uses one less convolution layer.       from keras. models import Model, load_modelfrom keras. layers import Input, Convolution2D, MaxPooling2D, Activation, Dropout, Flatten, Dense  Using TensorFlow backend.         img_in = Input(shape=(120, 160, 3), name=&#39;img_in&#39;)angle_in = Input(shape=(1,), name=&#39;angle_in&#39;)x = Convolution2D(8, 3, 3)(img_in)x = Activation(&#39;relu&#39;)(x)x = MaxPooling2D(pool_size=(2, 2))(x)x = Convolution2D(16, 3, 3)(x)x = Activation(&#39;relu&#39;)(x)x = MaxPooling2D(pool_size=(2, 2))(x)x = Convolution2D(32, 3, 3)(x)x = Activation(&#39;relu&#39;)(x)x = MaxPooling2D(pool_size=(2, 2))(x)merged = Flatten()(x)x = Dense(256)(merged)x = Activation(&#39;linear&#39;)(x)x = Dropout(. 2)(x)angle_out = Dense(1, name=&#39;angle_out&#39;)(x)model = Model(input=[img_in], output=[angle_out])model. compile(optimizer=&#39;adam&#39;, loss=&#39;mean_squared_error&#39;)model. summary()  ____________________________________________________________________________________________________Layer (type)           Output Shape     Param #   Connected to           ====================================================================================================img_in (InputLayer)       (None, 120, 160, 3)  0                      ____________________________________________________________________________________________________convolution2d_1 (Convolution2D) (None, 118, 158, 8)  224     img_in[0][0]           ____________________________________________________________________________________________________activation_1 (Activation)    (None, 118, 158, 8)  0      convolution2d_1[0][0]      ____________________________________________________________________________________________________maxpooling2d_1 (MaxPooling2D)  (None, 59, 79, 8)   0      activation_1[0][0]        ____________________________________________________________________________________________________convolution2d_2 (Convolution2D) (None, 57, 77, 16)  1168    maxpooling2d_1[0][0]       ____________________________________________________________________________________________________activation_2 (Activation)    (None, 57, 77, 16)  0      convolution2d_2[0][0]      ____________________________________________________________________________________________________maxpooling2d_2 (MaxPooling2D)  (None, 28, 38, 16)  0      activation_2[0][0]        ____________________________________________________________________________________________________convolution2d_3 (Convolution2D) (None, 26, 36, 32)  4640    maxpooling2d_2[0][0]       ____________________________________________________________________________________________________activation_3 (Activation)    (None, 26, 36, 32)  0      convolution2d_3[0][0]      ____________________________________________________________________________________________________maxpooling2d_3 (MaxPooling2D)  (None, 13, 18, 32)  0      activation_3[0][0]        ____________________________________________________________________________________________________flatten_1 (Flatten)       (None, 7488)     0      maxpooling2d_3[0][0]       ____________________________________________________________________________________________________dense_1 (Dense)         (None, 256)      1917184   flatten_1[0][0]         ____________________________________________________________________________________________________activation_4 (Activation)    (None, 256)      0      dense_1[0][0]          ____________________________________________________________________________________________________dropout_1 (Dropout)       (None, 256)      0      activation_4[0][0]        ____________________________________________________________________________________________________angle_out (Dense)        (None, 1)       257     dropout_1[0][0]         ====================================================================================================Total params: 1,923,473Trainable params: 1,923,473Non-trainable params: 0____________________________________________________________________________________________________  Train the model. : I've learned the hard way that even if everything to this point is perfect, your autopilot won't work if you don't train it correctly. The biggest problem I ran into was over fitting the model so that it would not work in evenlly slightly different scenarios. Here are 2 Keras callbacks that will save you time. Warning - This will take a long time (3hrs) if only using a CPU I ran this notebook on my Dell XPS notebook that does not have a CUDA compatible GPU so it's very slow and freezes. To speed up training you can uses a EC2 instance with a GPU. Several instance images exist with Keras and Tensorflow already loaded.       import osfrom keras import callbacksmodel_path = os. path. expanduser(&#39;~/best_autopilot. hdf5&#39;)#Save the model after each epoch if the validation loss improved. save_best = callbacks. ModelCheckpoint(model_path, monitor=&#39;val_loss&#39;, verbose=1,                   save_best_only=True, mode=&#39;min&#39;)#stop training if the validation loss doesn&#39;t improve for 5 consecutive epochs. early_stop = callbacks. EarlyStopping(monitor=&#39;val_loss&#39;, min_delta=0, patience=5,                   verbose=0, mode=&#39;auto&#39;)callbacks_list = [save_best, early_stop]    For this notebook, I'll only train the model for 4 epochs.       model. fit(train_X, train_Y, batch_size=64, nb_epoch=4, validation_data=(val_X, val_Y), callbacks=callbacks_list)  Train on 12626 samples, validate on 789 samplesEpoch 1/412608/12626 [============================&gt;. ] - ETA: 0s - loss: 821. 4849  Epoch 00000: val_loss improved from inf to 516. 59291, saving model to /home/wroscoe/best_autopilot. hdf512626/12626 [==============================] - 384s - loss: 822. 5694 - val_loss: 516. 5929Epoch 2/412608/12626 [============================&gt;. ] - ETA: 0s - loss: 430. 3060 Epoch 00001: val_loss improved from 516. 59291 to 384. 87241, saving model to /home/wroscoe/best_autopilot. hdf512626/12626 [==============================] - 400s - loss: 430. 4499 - val_loss: 384. 8724Epoch 3/412608/12626 [============================&gt;. ] - ETA: 0s - loss: 348. 3565 Epoch 00002: val_loss improved from 384. 87241 to 321. 23424, saving model to /home/wroscoe/best_autopilot. hdf512626/12626 [==============================] - 328s - loss: 348. 1003 - val_loss: 321. 2342Epoch 4/412608/12626 [============================&gt;. ] - ETA: 0s - loss: 304. 5375 Epoch 00003: val_loss did not improve12626/12626 [==============================] - 327s - loss: 304. 4417 - val_loss: 326. 8560&lt;keras. callbacks. History at 0x7f3f686b78d0&gt;  Evaluate Performance : We can check if our models predictions are reasonable by plotting the predictions vs the actual values. The first graph shows that there is a learned relationship in our test data (not seen by model during training).       import pandas as pdmodel = load_model(model_path)test_P = model. predict(test_X)test_P = test_P. reshape((test_P. shape[0],))           df = pd. DataFrame({&#39;predicted&#39;:test_P, &#39;actual&#39;:test_Y})ax = df. plot. scatter(&#39;predicted&#39;, &#39;actual&#39;)#ax. set_ylabel(&quot;steering angle&quot;)    This second graph uses the unshuffled data that includes the training data to show the predicted angles closely follow the actual steering angles.       P = model. predict(X[:700])#predict outputs nested arrays so we need to reshape to plot. P = P. reshape((P. shape[0],)) ax = pd. DataFrame({&#39;predicted&#39;:P, &#39;actual&#39;:Y[:700]}). plot()ax. set_ylabel(&quot;steering angle&quot;)  &lt;matplotlib. text. Text at 0x7f3ebb13a7f0&gt;  Next steps : Improve Model This model is naive because it doesn't use past values to help predict the future. We could experiment with the model by feeding past steering angles as inputs to the model, add a recurrent layer, or just change the structure of the convolution layers. Add more data This model will improve as we add more driving data. Predict throttle outputs Currently the autopilot only steers and maintains a constant speed. A more sophisticated model would speed up on straightaways and slow down before curbs. "
    }, {
    "id": 8,
    "url": "https://www.wroscoe.com/2017/generate_movie_for_cnns.html",
    "title": "Generate a movie to test that your CNN is actually training.",
    "body": "2017/01/02 -           When training convolution neural networks (CNNs) doesn't work, it's difficult to know what went wrong. A starting point for debugging these networks is training them on clean data with clear patters. In this notebook I create a simple image sequence of a moving square and attempt to predict its x (horizontal) cordinate.       import numpy as npimport random from matplotlib. pyplot import imshowfrom matplotlib import pyplot as pltfrom matplotlib import cm%matplotlib inline     This function can return the x and y possition but for now we just want to predict the x possition of the square.       def moving_square(n_frames=100, return_x=True, return_y=True):    &#39;&#39;&#39;  Generate sequence of images of square bouncing around   the image and labels of its coordinates. Can be used as a   basic simple performance test of convolution networks.   &#39;&#39;&#39;    row = 120  col = 160  movie = np. zeros((n_frames, row, col, 3), dtype=np. float)  labels = np. zeros((n_frames, 2), dtype=np. float)  #initial possition  x = np. random. randint(20, col-20)  y = np. random. randint(20, row-20)    # Direction of motion  directionx = -1  directiony = 1    # Size of the square  w = 4    for t in range(n_frames):    #move    x += directionx    y += directiony        #make square bounce off walls    if y &lt; 5 or y &gt; row-5:       directiony *= -1    if x &lt; 5 or x &gt; col-5:       directionx *= -1          #draw square and record labels    movie[t, y - w: y + w, x - w: x + w, 1] += 1    labels[t] = np. array([x, y])      #only return requested labels  if return_x and return_y:    return movie, labels  elif return_x and not return_y:    return movie, labels[:,0]  else:    return movie, labels[:,1]    Here we create images and the labels of the x possition. Both are numpy arrays containing 2000 samples each.       movie, labels = moving_square(2000, return_y=False)    Here we can see how the square bounces around the image to give us a wide range of possitions.       fig, ax = plt. subplots(1, 10, figsize=(15, 6),             subplot_kw={&#39;adjustable&#39;: &#39;box-forced&#39;})axoff = np. vectorize(lambda ax:ax. axis(&#39;off&#39;))axoff(ax)for i in range(10):  frame = i*20  ax[i]. imshow(movie[frame])  ax[i]. set_title(labels[frame])          def split_data(X, Y, test_frac=. 8):  count = len(X)  assert len(X) == len(Y)    cutoff = int((count * test_frac) // 1)    X_train = X[:cutoff]  Y_train = Y[:cutoff]    X_test = X[cutoff:]  Y_test = Y[cutoff:]    return X_train, Y_train, X_test, Y_test  movie_train, labels_train, movie_test, labels_test = split_data(movie, labels)print(&#39;training samples: %s,  test samples: %s&#39; %(len(movie_train), len(movie_test)))  training samples: 1600,  test samples: 400  Now that we have split our data into our training and test sets, we can create our model to test. For this example, well use a 3 layer convolution network with a dense layer at the end.       from keras. layers import Input, Embedding, LSTM, Dense, mergefrom keras. models import Modelfrom keras. layers import Convolution2D, MaxPooling2D,from keras. layers import Activation, Dropout, Flatten, Dense          def cnn3_full1():  img_in = Input(shape=(120, 160, 3), name=&#39;img_in&#39;)  angle_in = Input(shape=(1,), name=&#39;angle_in&#39;)  x = Convolution2D(8, 3, 3)(img_in)  x = Activation(&#39;relu&#39;)(x)  x = MaxPooling2D(pool_size=(2, 2))(x)  x = Convolution2D(16, 3, 3)(x)  x = Activation(&#39;relu&#39;)(x)  x = MaxPooling2D(pool_size=(2, 2))(x)  x = Convolution2D(32, 3, 3)(x)  x = Activation(&#39;relu&#39;)(x)  x = MaxPooling2D(pool_size=(2, 2))(x)  merged = Flatten()(x)  #merged = merge([flat, angle_in], mode=&#39;concat&#39;, concat_axis=-1)  x = Dense(256)(merged)  x = Activation(&#39;linear&#39;)(x)  x = Dropout(. 2)(x)  angle_out = Dense(1, name=&#39;angle_out&#39;)(x)  model = Model(input=[img_in], output=[angle_out])  return model    Since we are estimating a floating point value between 1 and 120 we've set our activation function to be linear and we'll use a mean squared error(mse) loss function.       model = cnn3_full1()model. compile(loss=&#39;mse&#39;, optimizer=&#39;adam&#39;)          model. fit(movie_train, labels_train, batch_size=32, nb_epoch=10,     validation_data=(movie_test, labels_test))  Train on 1600 samples, validate on 400 samplesEpoch 1/101600/1600 [==============================] - 19s - loss: 3231. 6821 - val_loss: 1382. 9762Epoch 2/101600/1600 [==============================] - 25s - loss: 506. 8916 - val_loss: 185. 6907Epoch 3/101600/1600 [==============================] - 25s - loss: 141. 4330 - val_loss: 104. 8761Epoch 4/101600/1600 [==============================] - 25s - loss: 93. 5230 - val_loss: 73. 3963Epoch 5/101600/1600 [==============================] - 27s - loss: 64. 1208 - val_loss: 61. 7327Epoch 6/101600/1600 [==============================] - 26s - loss: 50. 9679 - val_loss: 70. 5726Epoch 7/101600/1600 [==============================] - 33s - loss: 44. 5662 - val_loss: 69. 3478Epoch 8/101600/1600 [==============================] - 26s - loss: 36. 7403 - val_loss: 62. 1258Epoch 9/101600/1600 [==============================] - 32s - loss: 32. 8558 - val_loss: 62. 8279Epoch 10/101600/1600 [==============================] - 33s - loss: 30. 0092 - val_loss: 56. 4622&lt;keras. callbacks. History at 0x7f8d8083cb38&gt;  Our model here shows addequate training after 10 epochs. By showing the actual vs predited values of the test data, we can see that most predictions are within 1 pixel of the actual value. Now that we're sure that our model can learn a simple environment, we can try it on more complicated ones.       import pandas as pdpredictions = model. predict(movie_test[:400])results = {&#39;angle_pred&#39;:predictions[:,0],      &#39;angle_actual&#39;: labels_test[:400]}df = pd. DataFrame(data=results,)df           angle_actual   angle_pred         0   56. 0   55. 233990       1   57. 0   56. 693146       2   58. 0   57. 861286       3   59. 0   58. 791832       4   60. 0   59. 036770       5   61. 0   60. 441486       6   62. 0   61. 689087       7   63. 0   63. 456985       8   64. 0   64. 348381       9   65. 0   66. 222473       10   66. 0   67. 130646       11   67. 0   67. 738564       12   68. 0   67. 963821       13   69. 0   68. 935982       14   70. 0   69. 549744       15   71. 0   71. 431396       16   72. 0   72. 390083       17   73. 0   74. 190582       18   74. 0   74. 819740       19   75. 0   75. 444885       20   76. 0   75. 461914       21   77. 0   76. 146454       22   78. 0   76. 133331       23   79. 0   77. 773743       24   80. 0   78. 428741       25   81. 0   79. 718063       26   82. 0   79. 724319       27   83. 0   80. 628311       28   84. 0   81. 303391       29   85. 0   82. 617683       . . .    . . .    . . .        370   122. 0   121. 601166       371   123. 0   126. 386185       372   124. 0   126. 329117       373   125. 0   124. 133636       374   126. 0   121. 341873       375   127. 0   122. 241898       376   128. 0   118. 468033       377   129. 0   116. 506271       378   130. 0   115. 494576       379   131. 0   114. 433235       380   132. 0   113. 245926       381   133. 0   109. 520828       382   134. 0   108. 485291       383   135. 0   111. 566132       384   136. 0   113. 819847       385   137. 0   117. 470505       386   138. 0   125. 346176       387   139. 0   137. 456451       388   140. 0   143. 929260       389   141. 0   148. 688904       390   142. 0   151. 356018       391   143. 0   160. 217545       392   144. 0   159. 777679       393   145. 0   159. 734161       394   146. 0   155. 533234       395   147. 0   153. 263718       396   148. 0   144. 463562       397   149. 0   127. 741280       398   150. 0   111. 309967       399   151. 0   119. 974045   400 rows × 2 columns         ax = df. plot()ax. set_xlabel(&quot;samples&quot;)ax. set_ylabel(&quot;x value&quot;)  &lt;matplotlib. text. Text at 0x7f8d805741d0&gt;  These results of the test data show the actual angle and the predicted angle. The prediction accuracy in the middle of the image (x value between 100 and 40) is more accurate than the x values less than 40 and greater than 100. This is likely due to the view samples that occurred in those ranges. "
    }, {
    "id": 9,
    "url": "https://www.wroscoe.com/2016/rainwater-economics.html",
    "title": "Urban Rainwater Economics",
    "body": "2016/10/08 -           This is a quick simulation to see how a rainwater collection system would work on my house in Oakland. You can edit the values to see what how the sytem would work for your house. First lets define the essential parts of our rainwater system. rainfall - rain that falls on an area (inches)stored water - water stored for later use (gallons)collection area - space availible to collect rainwater (square feet)irrigation - water used on crops (inches or gallons)irrigated area - area that needs irrigationWe'll simulate how the system changes over time to see what size of water tank would be needed to store all the rainwater. Second we'll look ot see if it makes economic sense to store the rain water. Rainwater Availible : My house is a two story house with a roof area of about 800 feet. I've used the average inches of rainfall per month from weather. com.       #months used to plotmonths = [&#39;Jan&#39;, &#39;Feb&#39;, &#39;Mar&#39;, &#39;Apr&#39;, &#39;May&#39;, &#39;Jun&#39;,      &#39;Jul&#39;, &#39;Aug&#39;, &#39;Sep&#39;, &#39;Oct&#39;, &#39;Nov&#39;, &#39;Dec&#39;]collection_area = 800 #sqft of where you collect rain#inches of rain per arearainfall =  [2,  1,   . 5,  . 5,  . 5,  1,          1,   1,   1,   3,   8,   8 ]          # return the gallons equivalent to inches of rain falling on an areadef in_to_gal(inches, sqft): return inches * sqft * 144 * 0. 004329rain_collected = [int(in_to_gal(i, collection_area)) for i in rainfall]rain_collected  [997, 498, 249, 249, 249, 498, 498, 498, 498, 1496, 3989, 3989]  Water Use : The amount of water needed depends on the area to irrigate, and the rainfall and temperature of the location. For this example the i'm assuming that my garden needs 9 inches of irrigation per month during the hottest months. In Oakland it is 20 degrees warmer in the summer which causes more water to be evaporated from the soil and plants. To account for this we apply a seasonal scale to lower the irrigation demand in the winder.       irrigation_area = 400 #sqftmax_irrigation_demand = 9. 0 #water needed during hot months inches per monthseason_scale = [. 3, . 4, . 4, . 5, . 6, . 8, 1. , 1. , 1. , . 8, . 6, . 5]irrigation_demand = [i * max_irrigation_demand for i in season_scale]          #irrigation is not needed when it rainsirrigation_used = [max(irrigation_demand[i] - rain_inches[i], 0) for i in range(12) ]#convert to gallonsirrigation_used = [in_to_gal(irrigation_used[i], irrigation_area) for i in range(12)]    Visualize : We can see plot these supply and demand curves to see that they do not happen at the same times.       %matplotlib inlineimport pandas as pddf = pd. DataFrame({&#39;rain&#39;:rain, &#39;irrigation&#39;: irrigation_used})df. plot()  &lt;matplotlib. axes. _subplots. AxesSubplot at 0x7fc968a1d940&gt;  Simulate Here we create a function to simulate a system that saves the rainwater and is used later. At first we'll assume that our tank can hold 1000 gallons.       from copy import deepcopystored_history = []stored = 0def run_year(stored, tank_size=1000):  for i, m in enumerate(months):    #keep the rain     stored = max(stored - irrigation_used[i] + rain[i], 0)        #only keep the water that fits    stored = min(stored, tank_size)    #record stored value for later    stored_history. append(deepcopy(stored))  return stored    Now we run simulation for a year and visualize the results       stored = run_year(stored)data = {&#39;rain&#39;: rain, &#39;irrigation&#39;:irrigation_used,     &#39;stored&#39;:stored_history}df = pd. DataFrame(data, index=months)df. plot(kind=&#39;bar&#39;)  &lt;matplotlib. axes. _subplots. AxesSubplot at 0x7fc9667807b8&gt;  This graph shows that our 1000 gallon tank is not close to big enough. So, we'll rerun the simulation to find the right size tank.       tank_size = 0stored=0min_stored = 0 #used to check if tank gets empty during the yearwhile min_stored &lt;= 0:   tank_size += 10  stored = run_year(stored, tank_size=tank_size)  min_stored = min(stored_history[-12:])print(tank_size)data = {&#39;rain&#39;: rain, &#39;irrigation&#39;:irrigation_used,     &#39;stored&#39;:stored_history[-12:]}df = pd. DataFrame(data, index=months)df. plot(kind=&#39;bar&#39;)  7940&lt;matplotlib. axes. _subplots. AxesSubplot at 0x7fc9662def98&gt;  How big is this tank? : Where would it be possible to store this tank?       def gal_to_ft3 (gal): return gal * 0. 133681gal_to_ft3(tank_size)  1061. 42714  For reference: : Cargo container (8ft x 8ft x 20ft):  1290 ft^3Homemade water tank (3ft x 3ft x 3ft)   9 ft^3Turns out this is a massive tank (similar to a large truck). Lets see if it makes economic sense. Irrigation and tank costs : I looked up my EBMUD water rates and find they charge a little over $5 for every 100 cubic feet of water I use.       irrigation_costs = 5. 45 #$ per 100 cubic feetdef ft3_to_gal (cubic_feet): return cubic_feet / 0. 133681irrigation_costs = irrigation_costs / ft3_to_gal(100)print(irrigation_costs)sum(irrigation_used)*irrigation_costs  0. 00728561450000000190. 28854322409379  Results : We're done here. Given that we'd need a cargo containers to save $90 per year, we can stop this analysis with the the conclusion that it will not save money to collect rain water. So when you have this idea in a down pour, just realax and enjoy it.  "
    }, {
    "id": 10,
    "url": "https://www.wroscoe.com/transit-first-principles.html",
    "title": "Exploring first principles of transit systems through simulation.",
    "body": "2016/09/08 -           This document attempts to model and evaluate the essential nature of transit systems using simulations writen in python. I'll use these models to explore the first principles of transit. First priciples are the fundamental properties of a system that determine it's behavior. Elon musk used these to explain why batteries and space travel could become much cheaper. Here I've tried to quantify the assumptions so they can be challenged explicity. Approach : This is a difficult problem because there are many factors that influence the behavior of a transit system. To simplify the simulation, we'll only model the most essentional objects and processs of transit. First lets define the terms we'll be using: Objects : rider - a person with a destination (end stop)vehicle - the container that moves riders to their end stop along a pathpath - how vehicles can move between stopsstop - a point along a route where a vehicle can load/unload ridersProcesses : move - a vehicle has to move along a routeunload vehicle - riders transfered from a vehicle to a stop. load vehicle - riders transfered from stop to vehicle. create new riders - create riders that are waiting to be picked upKey Measurments : trip time - time for rider to get to their destinationflow - riders passing a point over time (usually measured at each station)Variables : One thing that makes transit systems tricky is that they have so many variables. changing more than one of these at a time makes it dificutle to identify which variable has the effect. vehicle frequency - vehicle capacity - number of vehicles - vehicle schedule - path shapes - number of stations - time between stations - time vehicles spend at stop - number of new passengers - destinations of new passengers, TLDR - What we've learned. : This document includes working python code you can run and tweak on a Jupyter Notebook. Here are the key takeaways from the simulations of circular linear transit systems below: Larger vehicles sometimes reduce trip times. At a point icreasing the vehicle capacity just adds empty seats. Higher vehicle frequency always reduces trip times. System flow is always less than the sysem rider demand. What's missing. : This document only models a fraction of the potential transit systems. You can fork and improve this document on github. How do linear and point to point paths change system behavior. How does the end stop demand distributions affect system performance. Can system performance be improved with route logic? Does more information (knowing where riders want to go?) allow for more efficient systems?Cost structures of real transit systems. How does the nature of existing transit systems allow them to improve?How does speed, distance, acceleration, random stops and other factors affect trip time. Model Riders : To measure wait time and efficiency we need to know where and when people want to go. For this I represent a rider as a tuple (destination stop, time trip began) and group them into a list.       class Riders(list):  def __init__(self, *args):    list. __init__(self, *args)  def put(self, riders):    &#39;&#39;&#39; add riders&#39;&#39;&#39;    self += riders      def get(self, matches=None, n=None):    &#39;&#39;&#39;     return n matching riders and remove them    &#39;&#39;&#39;        removed = []    removed_index = []        if n is None and n != 0:       n = len(self)        if matches is None:      removed = self[:n] #get all riders      del self[:n] #remove riders      else:      i = 0      for r in self:        if i == n: break                  if r[0] in matches:          removed. append(r)          removed_index. append(i)          i += 1          for i in sorted(removed_index, reverse=True):      del self[i]              return removed              #rider going to station A that started their journy at time 3rider1 = (&#39;A&#39;, 3) riders = Riders([rider1, (&#39;B&#39;,4)]) riders. put([(&#39;C&#39;, 5)]) #add another riderriders  [(&#39;A&#39;, 3), (&#39;B&#39;, 4), (&#39;C&#39;, 5)]        riders. get(matches=[&#39;A&#39;, &#39;C&#39;], n=1)  [(&#39;A&#39;, 3)]  Stops : Stops are points distributed long a path where riders can waite to board vehicles.       class Stop():  def __init__(self, name, riders):    self. name = name    self. riders = riders      def load(self, riders):    &#39;&#39;&#39; add riders to the stop&#39;&#39;&#39;    self. riders += riders      def unload(self, n=None, matches=None):    &#39;&#39;&#39; take riders from the stop&#39;&#39;&#39;    riders = self. riders. get(n=n, matches=matches)    return riders            s = Stop(&#39;A&#39;, riders )s. load(riders)s. riders  [(&#39;B&#39;, 4), (&#39;C&#39;, 5), (&#39;B&#39;, 4), (&#39;C&#39;, 5)]  Paths : Paths are a representation of how a vehicle can travel.       class CirclePath():    def __init__(self, stop_names, durations):    self. stops = stop_names    self. durations = durations      def next_stops(self, start):    &#39;&#39;&#39; return a list of the next possible stops and their duration&#39;&#39;&#39;    index = self. stops. index(start)    if index == len(self. stops)-1:      index = -1        S = [(self. stops[index+1], self. durations[index+1] )]    return S          path = CirclePath(list(&#39;ABCDE&#39;), [10]*5)path. next_stops(&#39;E&#39;)  [(&#39;A&#39;, 10)]  Vehicles : Vehicles load riders at stops and move along the path to another stop to unload riders.       class Vehicle():  def __init__(self, name, current_stop, capacity=10):    self. name = name    self. end_stop = current_stop #destinations    self. t = 0 #time to destination    self. riders = Riders() #riders object    self. capacity = capacity #max riders      def load(self, riders):    &#39;&#39;&#39; add riders to the vehicle&#39;&#39;&#39;    self. riders += riders      def unload(self, matches=None):    &#39;&#39;&#39; unload riders from the vehicle&#39;&#39;&#39;    unloaded = self. riders. get(matches=matches)    return unloaded    def spaces(self):    &#39;&#39;&#39; return how many riders can fit in the vehicle&#39;&#39;&#39;    return self. capacity - len(self. riders)    def move(self):    &#39;&#39;&#39; move one step in time closer to the stop&#39;&#39;&#39;    self. t -= 1      def set_route(self, end_stop, t):    &#39;&#39;&#39; set route for vehicle&#39;&#39;&#39;    self. end_stop = end_stop    self. t = t             v = Vehicle(&#39;car&#39;, &#39;B&#39;, 10)v. riders  []        v. load(riders)v. riders  [(&#39;B&#39;, 4), (&#39;C&#39;, 5), (&#39;B&#39;, 4), (&#39;C&#39;, 5)]  Generators : Here are helper methods to create our objects.       import randomdef new_riders(n, stop_names, t):   &#39;&#39;&#39; return a list of n riders with a uniform distribution of stop_names&#39;&#39;&#39;  riders = []  for i in range(n):    stop_name = random. sample(stop_names, 1)[0]    t=t    riders. append((stop_name, t))  return Riders(riders)    def new_vehicles(n, stop_names):  &#39;&#39;&#39; return a list of n vehicles starting at the first n stations&#39;&#39;&#39;  vehicles = []  for i in range(n):    name = str(i)    stop = stop_names[i]    t = 0    riders = new_riders(3, stop_names, 0)    v = Vehicle(name, stop, t, riders, 20)    vehicles. append(v)  return vehiclesdef new_stops(stop_names):  &#39;&#39;&#39; return a dictionary of stops at stop_names&#39;&#39;&#39;  stops = {}  for s in stop_names:    riders = new_riders(3, stop_names, 0)    stop = Stop(s,riders)    stops[stop. name] = stop  return stops    Data Recorder : Instead of using print statements, here is a simple recorder class to save data dictionaries and return them as a pandas DataFrame for easy ploting and metrics.       import pandas as pdclass Recorder ():  def __init__(self):    self. records = {}    self. columns = {}  def save(self, name, dct={}):    if name not in self. records. keys():      self. records[name]=[]    self. records[name]. append(dct)      def get(self, name):    df = pd. DataFrame(self. records[name])    df = df. fillna(0)    return df          R = Recorder()R. save(&#39;color&#39;, {&#39;blue&#39;: i})for i in range(3):  R. save(&#39;speed&#39;, {&#39;mph&#39;: i})  R. get(&#39;speed&#39;) #return pandas DataFrame (use . plot() to visualize)           mph         0   0       1   1       2   2     Simulate. : To move through time, our simulation updates all our objects in every time. In this case we move each train forward in time 1 step, if the       class Simulator():  def __init__(self, vehicles, stops, path):        self. R = Recorder()    self. t=0 #initialize at time = 0    #create dictionary of stop objects    self. stops = stops    #3 min between stops    self. path = path     self. vehicles = vehicles          class TrainSimulator(Simulator):  def __init__(self, vehicles, stops, path):    super(TrainSimulator, self). __init__(vehicles, stops, path)    def step(self):    &#39;&#39;&#39; Advance every object &amp; process through one step in time. &#39;&#39;&#39;    #remove passengers that have arrived at their end_stop    for n, s in self. stops. items():      s. unload(matches=[s. name])    #set new routes    for v in self. vehicles:      if v. t == 0:#vehicle at station        next_stop, t = self. path. next_stops(v. end_stop)[0]        v. set_route(next_stop, t)      #move vehicle      v. move()    #if vehicle is at a station    for v in [v for v in self. vehicles if v. t &lt;= 0]:      #unload riders      if v. t &lt;= 0:        unloaded = v. unload(v. end_stop)        self. stops[v. end_stop]. load(unloaded) #move unloaded passengers       #load riders      if v. t &lt;= 0:        matches = [s for s in self. stops. keys() if s != v. end_stop]        boarding = self. stops[v. end_stop]. unload(n=v. spaces(), matches=matches)        v. load(boarding)    #generate new riders at each stop    for n, s in self. stops. items():      stop_choices =[s for s in self. stops. keys() if s is not n]      s. load(new_riders(5, stop_choices , self. t))              def run(self, end_time):    &#39;&#39;&#39; run the seimulation until specified end time. &#39;&#39;&#39;        for i in range(end_time):      self. step()            self. t += 1      #record rider counts      data_dict = dict([(v. name, len(v. riders)) for v in self. vehicles ])      self. R. save(&#39;riders on vehicles&#39;, data_dict)      #record station counts      data_dict = dict([(n, len(s. riders)) for n, s in self. stops. items() ])      self. R. save(&#39;riders at stops&#39;, data_dict)            #record trip durations of riders that arrive at their end stops      for n,s in self. stops. items():        data = [{&#39;t&#39;:self. t, &#39;end_stop&#39;:s. name, &#39;duration&#39;:self. t - r[1]} for r in s. riders if r[0] == s. name ]        for d in data:          self. R. save(&#39;trip durations&#39;, d)          return self. R    Now we create the objects and loop over the step for the perod of time we want to simulate.       import string def new_train_sim(num_vehicles=1, num_stops=5, vehicle_capacity=10, spacing=10):    stop_names = string. ascii_uppercase[:num_stops]  stops = new_stops(stop_names)    vehicles = []  for i in range(num_vehicles):        vehicles. append(Vehicle (&#39;train %s&#39;%i, stop_names[i], capacity=vehicle_capacity) )  path = CirclePath(stop_names,[spacing]*num_stops)    return TrainSimulator(vehicles, stops, path)Sim = new_train_sim() #create simulationR = Sim. run(300) #run simulation for 300 steps    Visualize the number of riders waiting at each stop. : Here are we visualize the number of riders at each stop over time. The capacity of the system does not support the rider demand because the number of riders waiting increases over time.       %matplotlib inline df = R. get(&#39;riders at stops&#39;)ax = df. plot()#set axis labelsax. set_xlabel(&#39;time (minutes)&#39;); ax. set_ylabel(&#39;riders at stops&#39;);    Visualize the affects of a variable on system. : The graph above only shows the system perforace of one variable, rider backlog. Let's create a function to show a series of visuals for simulations run with different variables.       import matplotlib. pyplot as plt plt. rcParams[&quot;figure. figsize&quot;] = [10,6]def show(var_name, choices, steps=300):    TS = new_train_sim() #create sim to get the defaults  print(&#39;Linear Circular Path Model Defaults&#39;)  print(&#39;Vehicles: %d&#39; % len(TS. vehicles))  print(&#39;Vehicle Capacity %d &#39; % TS. vehicles[0]. capacity)  print(&#39;Stops: %d&#39; % len(TS. stops))  print(&#39;Time between stops: %d&#39; % TS. path. durations[0])  print(&#39;New riders per time step: %d&#39; % 5)    #create subplot  fig, axes = plt. subplots(nrows=3, ncols=len(choices))    for i, c in enumerate(choices):        TS = new_train_sim(**{var_name: c})    R = TS. run(steps)    #align axes for all subplots    xlim=[0,steps]    ylim=[0,300]        #graph of riders at stops    df = R. get(&#39;riders at stops&#39;)    ax = df. plot(ax=axes[0, i], title=var_name + str(c),           legend=False, sharey=True, sharex=True,          xlim=xlim, ylim=ylim)    ax. set_ylabel(&#39;riders at stops&#39;)    #graph of riders on vehicles    df = R. get(&#39;riders on vehicles&#39;)    ax = df. plot(ax=axes[1, i],          legend=False, sharey=True, sharex=True,          xlim=xlim, ylim=ylim)    ax. set_ylabel(&#39;riders on vehicles&#39;)        #time it took each passenger to get to their destination    df = R. get(&#39;trip durations&#39;)    df. plot. scatter(x=&#39;t&#39;, y=&#39;duration&#39;, ax=axes[2, i], s=1,            legend=False, sharey=True,             xlim=xlim, ylim=ylim)  plt. tight_layout()    Vehicle Capacity :       show(&#39;vehicle_capacity&#39;, [1, 30, 100, 250])  Linear Circular Path Model DefaultsVehicles: 1Vehicle Capacity 10 Stops: 5Time between stops: 10New riders per time step: 5  Capacity=1 Riders are created faster than the vehicles can transport them. Capacity=10 Riders are still created faster than they can be transported but at a slower rate. Capacity=100 Vehicles are now big enough to carry all the riders. Capacity=250 The same number of riders are waiting at the station but more more people are on the train at once. Vehicle Frequency :       show(&#39;spacing&#39;, [1, 3, 20, 50])  Linear Circular Path Model DefaultsVehicles: 1Vehicle Capacity 10 Stops: 5Time between stops: 10New riders per time step: 5  New riders from distributions of destimation demand. :       from math import cos, pidef map_dist(name, n):  &quot;&quot;&quot; return an distribution between 0 and 1 over a list of n  &quot;&quot;&quot;  if name == &#39;uniform&#39;:     dist = [1 for _ in range(n)] #all 1s      elif name == &#39;peak&#39;:    dist = [(-cos(i/n*2*pi)+1) / 2 for i in range(n)]  return dist    Metrics : Even these graphs aren't arent'enough to compare the changes relative to each other. To do this, we'll generate all the combinations simulation variables we want to measure, run the simulation with those variables and then record the measurements of the last 50 timesteps.       Sim = new_train_sim ()R = Sim. run(100)df = R. get(&#39;riders at stops&#39;)df. tail(5)           A   B   C   D   E         95   299   398   359   366   409       96   300   401   363   367   410       97   301   404   367   368   411       98   302   407   371   369   412       99   303   410   375   370   413           #make a single metric from the last time stepsdf. tail(10). mean(). sum() #average riders waiting at stops for last 10 timesteps  1826. 0        import itertools V = {   &#39;spacing&#39;: [1, 3, 20, 40],   &#39;vehicle_capacity&#39;: [1, 5, 10, 30, 50],   &#39;num_vehicles&#39;: [1, 2, 3, 4],   &#39;num_stops&#39;: [5, 10]  }combinations = list(itertools. product( *V. values() ) )combo_list = []sim_time = 500window = 100 #metrics come from the last window of timefor i, combo in enumerate(combinations):    print()  combo = dict(zip(V. keys(), combo))  Sim = new_train_sim (**combo)  R = Sim. run(sim_time)     df = R. get(&quot;trip durations&quot;)  trip_duration = df[df[&#39;t&#39;]&gt;sim_time-window][&#39;duration&#39;]. mean()    trips = len(df[df[&#39;t&#39;]&gt;sim_time-window])    combo[&#39;ave trip duration&#39;] = trip_duration  combo[&#39;trips&#39;] = trips  combo_list. append(combo)  metrics = pd. DataFrame(combo_list)          metrics. sort_values(&#39;trips&#39;). head()           ave trip duration   num_stops   num_vehicles   spacing   trips   vehicle_capacity         15   455. 057471   10   2   40   261   1       7   457. 659574   10   1   40   282   1       39   448. 689076   10   1   40   357   5       5   438. 500000   10   1   20   368   1       6   452. 470309   5   1   40   421   1     Interpreting the Results :       from pandas. tools. plotting import scatter_matrix#scatter_matrix(metrics, alpha=0. 2, figsize=(10, 10), diagonal=&#39;kde&#39;)print(&#39;Variable Correlations&#39;)metrics. corr()  Variable Correlations         ave trip duration   num_stops   num_vehicles   spacing   trips   vehicle_capacity         ave trip duration   1. 000000   0. 294499   -1. 732798e-01   7. 964563e-01   -0. 405027   -2. 942993e-01       num_stops   0. 294499   1. 000000   0. 000000e+00   0. 000000e+00   0. 516271   0. 000000e+00       num_vehicles   -0. 173280   0. 000000   1. 000000e+00   0. 000000e+00   0. 159940   1. 299078e-17       spacing   0. 796456   0. 000000   0. 000000e+00   1. 000000e+00   -0. 447169   5. 920546e-17       trips   -0. 405027   0. 516271   1. 599400e-01   -4. 471685e-01   1. 000000   3. 644382e-01       vehicle_capacity   -0. 294299   0. 000000   1. 299078e-17   5. 920546e-17   0. 364438   1. 000000e+00           # Correction Matrix Plotimport numpy as npnames = metrics. columns. valuescorrelations = metrics. corr()# plot correlation matrixfig = plt. figure(figsize=(10, 10))ax = fig. add_subplot(111)cax = ax. matshow(correlations, vmin=-1, vmax=1)fig. colorbar(cax)ticks = np. arange(0,6,1)ax. set_xticks(ticks)ax. set_yticks(ticks)ax. set_xticklabels(names)ax. set_yticklabels(names)plt. show()    "
    }];

var idx = lunr(function () {
    this.ref('id')
    this.field('title')
    this.field('body')
    this.metadataWhitelist = ['position']

    documents.forEach(function (doc) {
        this.add(doc)
    }, this)
});
function lunr_search(term) {
    document.getElementById('lunrsearchresults').innerHTML = '<ul></ul>';
    if(term) {
        document.getElementById('lunrsearchresults').innerHTML = "<p>Search results for '" + term + "'</p>" + document.getElementById('lunrsearchresults').innerHTML;
        //put results on the screen.
        var results = idx.search(term);
        if(results.length>0){
            //console.log(idx.search(term));
            //if results
            for (var i = 0; i < results.length; i++) {
                // more statements
                var ref = results[i]['ref'];
                var url = documents[ref]['url'];
                var title = documents[ref]['title'];
                var body = documents[ref]['body'].substring(0,160)+'...';
                document.querySelectorAll('#lunrsearchresults ul')[0].innerHTML = document.querySelectorAll('#lunrsearchresults ul')[0].innerHTML + "<li class='lunrsearchresult'><a href='" + url + "'><span class='title'>" + title + "</span><br /><span class='body'>"+ body +"</span><br /><span class='url'>"+ url +"</span></a></li>";
            }
        } else {
            document.querySelectorAll('#lunrsearchresults ul')[0].innerHTML = "<li class='lunrsearchresult'>No results found...</li>";
        }
    }
    return false;
}